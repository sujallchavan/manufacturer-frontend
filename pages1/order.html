<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Orders Management | Manufacturer Dashboard</title>

    <!-- Fonts -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900"
    />

    <!-- Icons -->
    <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
    
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <style>
        /* Enhanced Order Details Modal Styles */
.order-details-container {
  position: relative;
}

.status-ribbon {
  position: absolute;
  top: -15px;
  right: 20px;
  padding: 5px 15px;
  border-radius: 4px;
  color: white;
  font-weight: bold;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  z-index: 10;
}

.status-ribbon.badge-pending {
  background-color: #ffc107;
}

.status-ribbon.badge-approved {
  background-color: #28a745;
}

.status-ribbon.badge-disapproved {
  background-color: #dc3545;
}

.status-ribbon.badge-working {
  background-color: #17a2b8;
}

.status-ribbon.badge-completed {
  background-color: #6f42c1;
}

.info-card {
  border-radius: 10px;
  overflow: hidden;
  transition: transform 0.3s, box-shadow 0.3s;
  border: none;
  margin-bottom: 20px;
}

.info-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.info-card .card-header {
  border-bottom: 1px solid rgba(0,0,0,0.05);
  padding: 15px 20px;
}

.info-card .card-body {
  padding: 20px;
}

.info-item {
  display: flex;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px dashed #eee;
}

.info-item:last-child {
  margin-bottom: 0;
  padding-bottom: 0;
  border-bottom: none;
}

.info-label {
  font-weight: 500;
  color: #6c757d;
  min-width: 150px;
  display: flex;
  align-items: center;
}

.info-label i {
  width: 20px;
  text-align: center;
  margin-right: 8px;
}

.info-value {
  flex: 1;
  color: #495057;
}

.timeline-item {
  position: relative;
  padding-left: 30px;
  margin-bottom: 20px;
}

.timeline-item:last-child {
  margin-bottom: 0;
}

.timeline-dot {
  position: absolute;
  left: 0;
  top: 5px;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background-color: #e9ecef;
  border: 3px solid #dee2e6;
}

.timeline-item.active .timeline-dot {
  background-color: #43a047;
  border-color: #43a047;
}

.timeline-content h6 {
  font-weight: 600;
  margin-bottom: 5px;
}

.timeline-content p {
  color: #6c757d;
  margin-bottom: 0;
}

.description-text {
  white-space: pre-line;
  line-height: 1.6;
}

.attachment-item {
  display: flex;
  align-items: center;
  padding: 10px;
  border-radius: 8px;
  background-color: #f8f9fa;
}

.attachment-icon {
  font-size: 24px;
  margin-right: 15px;
  width: 40px;
  text-align: center;
}

.attachment-info h6 {
  margin-bottom: 5px;
  font-weight: 500;
}

.assigned-supplier {
  display: flex;
  align-items: center;
}

.supplier-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: #e3f2fd;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
  font-size: 24px;
  color: #1976d2;
}

.supplier-info h5 {
  margin-bottom: 5px;
}

.btn-group .btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

@media (max-width: 768px) {
  .info-item {
    flex-direction: column;
  }
  
  .info-label {
    margin-bottom: 5px;
    min-width: auto;
  }
  
  .assigned-supplier {
    flex-direction: column;
    text-align: center;
  }
  
  .supplier-avatar {
    margin-right: 0;
    margin-bottom: 15px;
  }
}
      /* Consistent with your dashboard styling */
      body {
        background-color: #f8f9fa;
        font-family: "Inter", sans-serif;
        overflow-x: hidden;
      }

      .sidebar {
        background: #fff;
        height: 100vh;
        position: fixed;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        width: 280px;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .main-content {
        margin-left: 280px;
        padding: 20px;
        transition: all 0.3s ease;
      }

      .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .card-header {
        background: #fff;
        border-bottom: 1px solid #eee;
        font-weight: 600;
      }

      .stat-card {
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-icon {
        font-size: 2rem;
        opacity: 0.8;
      }

      .nav-link {
        color: #495057;
        border-radius: 5px;
        margin: 5px 0;
      }

      .nav-link:hover,
      .nav-link.active {
        background: #43a047;
        color: white !important;
      }

      .table-responsive {
        border-radius: 10px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      table {
        margin-bottom: 0 !important;
        min-width: 600px;
      }

      /* Table header styles for mobile */
      .table-header-mobile {
        display: flex;
        flex-direction: column;
      }
      
      .table-header-mobile .search-row {
        order: 2; /* Move search below title on mobile */
      }
      
      @media (min-width: 768px) {
        .table-header-mobile {
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }
        
        .table-header-mobile .search-row {
          order: initial; /* Reset order for desktop */
        }
      }

      /* Search box styles */
      .search-box {
        max-width: 100%;
      }
      
      @media (min-width: 768px) {
        .search-box {
          max-width: 300px;
          margin-left: auto;
        }
      }

      /* Enhanced Pagination Styles */
      .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }

      .pagination {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
        padding: 0;
        list-style: none;
      }

      .page-item {
        margin: 0 2px;
      }

      .page-link {
        border-radius: 6px !important;
        min-width: 40px;
        text-align: center;
        border: 1px solid #dee2e6;
        color: #495057;
        transition: all 0.2s;
        padding: 0.5rem 0.75rem;
        display: block;
        text-decoration: none;
      }

      .page-link:hover {
        background-color: #f8f9fa;
        color: #43a047;
      }

      .page-item.active .page-link {
        background-color: #43a047;
        border-color: #43a047;
        color: white;
      }

      .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #dee2e6;
      }

      /* Status badges */
      .badge-pending {
        background-color: #ffc107;
        color: #212529;
      }
      
      .badge-approved {
        background-color: #28a745;
        color: white;
      }
      
      .badge-disapproved {
        background-color: #dc3545;
        color: white;
      }
      
      .badge-working {
        background-color: #17a2b8;
        color: white;
      }
      
      .badge-completed {
        background-color: #6f42c1;
        color: white;
      }

      /* Mobile Styles */
      @media (max-width: 992px) {
        .sidebar {
          transform: translateX(-100%);
          width: 280px;
        }

        .sidebar.active {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999;
          display: none;
        }

        .overlay.active {
          display: block;
        }

        .search-box {
          max-width: 100%;
          margin-top: 10px;
        }
      }

      /* Hamburger Menu */
      .hamburger {
        display: none;
        cursor: pointer;
        padding: 10px;
        margin-right: 15px;
      }

      .hamburger span {
        display: block;
        width: 25px;
        height: 3px;
        background: #333;
        margin: 5px 0;
        transition: all 0.3s;
      }

      @media (max-width: 992px) {
        .hamburger {
          display: block;
        }
      }

      /* Close icon animation */
      .hamburger.close-sidebar span:nth-child(1) {
        transform: rotate(45deg) translate(5px, 5px);
      }
      .hamburger.close-sidebar span:nth-child(2) {
        opacity: 0;
      }
      .hamburger.close-sidebar span:nth-child(3) {
        transform: rotate(-45deg) translate(5px, -5px);
      }

      /* Enhanced Pagination for Mobile */
      @media (max-width: 767px) {
        .pagination {
          flex-wrap: wrap;
          gap: 4px;
          justify-content: center;
        }
        
        .page-item {
          margin: 0;
        }
        
        .page-link {
          min-width: 32px;
          padding: 0.375rem 0.5rem;
          font-size: 0.875rem;
        }
        
        /* Show only essential items on mobile */
        .page-item:not(.active):not(.disabled):not(:first-child):not(:last-child):not(.prev):not(.next) {
          display: none;
        }
        
        /* Style prev/next buttons */
        .page-item.prev .page-link::before {
          content: "«";
        }
        
        .page-item.next .page-link::before {
          content: "»";
        }
        
        .page-item.prev .page-link span,
        .page-item.next .page-link span {
          display: none;
        }
        
        /* Ensure first, last, prev, next are always visible */
        .page-item.active,
        .page-item.disabled,
        .page-item:first-child,
        .page-item:last-child,
        .page-item.prev,
        .page-item.next {
          display: block;
        }
      }

      /* Custom Modal Enhancements */
      .modal-content {
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1.25rem rgba(0, 0, 0, 0.15);
        overflow: hidden;
      }

      .modal-header,
      .modal-footer {
        background-color: #f8f9fa;
        border: none;
        padding: 1.25rem 1.5rem;
      }

      .modal-title {
        font-size: 1.3rem;
        font-weight: 600;
      }

      .modal-body {
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.85);
      }

      .form-label {
        font-weight: 500;
        color: #495057;
      }

      .form-control[readonly] {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 0.5rem;
      }

      .btn-primary,
      .btn-secondary,
      .btn-success {
        border-radius: 0.5rem;
        padding: 0.5rem 1.25rem;
        font-weight: 500;
      }
    </style>
  </head>

  <body>
    <!-- Overlay for mobile sidebar -->
    <div class="overlay"></div>

    <!-- Sidebar -->
    <div class="sidebar col-md-3 col-lg-2 d-md-block">
      <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <a class="navbar-brand d-flex align-items-center" href="#">
            <img
              src="../assets/img/logo-ct-dark.png"
              width="30"
              height="30"
              class="me-2"
            />
            <span class="font-weight-bold">Manufacturer</span>
          </a>
          <div class="hamburger close-sidebar d-lg-none">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
        <hr />

        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="material-symbols-rounded me-2">dashboard</i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="projects.html">
              <i class="material-symbols-rounded me-2">table_view</i>
              Projects
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="#">
              <i class="material-symbols-rounded me-2">receipt_long</i>
              Orders
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="notifications.html">
              <i class="material-symbols-rounded me-2">notifications</i>
              Notifications
              <span class="badge bg-danger ms-2" id="notificationCount">0</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="new.html">
              <i class="material-symbols-rounded me-2">group</i>
              User Management
            </a>
          </li>
          <li class="nav-item mt-3">
            <h6 class="text-uppercase text-muted small fw-bold px-3">
              Account
            </h6>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              href="#"
              data-bs-toggle="modal"
              data-bs-target="#profileModal"
            >
              <i class="material-symbols-rounded me-2">person</i>
              Profile
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutBtn">
              <i class="material-symbols-rounded me-2">logout</i>
              Logout
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <header class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
          <div class="hamburger open-sidebar me-3 d-lg-none">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div>
            <h3 class="mb-0">Orders Management</h3>
            <p class="text-muted mb-0">
              Manage all customer orders and projects
            </p>
          </div>
        </div>
        <div class="d-flex align-items-center">
          <div class="input-group search-box d-none d-md-flex">
            <input type="text" class="form-control" placeholder="Search..." id="globalSearch" />
            <button class="btn btn-outline-secondary" type="button">
              <i class="material-symbols-rounded">search</i>
            </button>
          </div>
          <button class="btn btn-link text-dark ms-3" id="notificationBtn">
            <i class="material-symbols-rounded">notifications</i>
            
          </button>
        </div>
      </header>

      <!-- Stats Cards -->
      <div class="row">
        <div class="col-md-6 col-lg-3">
          <div class="card stat-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="text-muted mb-2">Total Orders</h6>
                  <h3 class="mb-0" id="totalOrdersCount">0</h3>
                  <p class="text-muted small mb-0">
                    <i class="fas fa-boxes me-1"></i> All orders
                  </p>
                </div>
                <div
                  class="stat-icon bg-gradient-primary text-white rounded-circle p-3"
                >
                  <i class="material-symbols-rounded">list_alt</i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3">
          <div class="card stat-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="text-muted mb-2">Pending Approval</h6>
                  <h3 class="mb-0" id="pendingOrdersCount">0</h3>
                  <p class="text-warning small mb-0">
                    <i class="fas fa-clock me-1"></i> Waiting for review
                  </p>
                </div>
                <div
                  class="stat-icon bg-gradient-warning text-white rounded-circle p-3"
                >
                  <i class="material-symbols-rounded">pending</i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3">
          <div class="card stat-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="text-muted mb-2">Approved Orders</h6>
                  <h3 class="mb-0" id="approvedOrdersCount">0</h3>
                  <p class="text-success small mb-0">
                    <i class="fas fa-check-circle me-1"></i> Approved
                  </p>
                </div>
                <div
                  class="stat-icon bg-gradient-success text-white rounded-circle p-3"
                >
                  <i class="material-symbols-rounded">check_circle</i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3">
          <div class="card stat-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="text-muted mb-2">Completed Orders</h6>
                  <h3 class="mb-0" id="completedOrdersCount">0</h3>
                  <p class="text-info small mb-0">
                    <i class="fas fa-clipboard-check me-1"></i> Finished
                  </p>
                </div>
                <div
                  class="stat-icon bg-gradient-info text-white rounded-circle p-3"
                >
                  <i class="material-symbols-rounded">done_all</i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Orders Table -->
      <div class="card mt-4">
        <div class="card-header table-header-mobile">
          <div class="d-flex justify-content-between align-items-center mb-2 mb-md-0">
            <h5 class="mb-0">All Orders</h5>
            <div class="dropdown d-none d-md-block">
              <button
                class="btn btn-sm btn-outline-secondary dropdown-toggle"
                type="button"
                id="filterDropdown"
                data-bs-toggle="dropdown"
              >
                Filter by Status
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-status="all">All Orders</a></li>
                <li><a class="dropdown-item" href="#" data-status="pending">Pending</a></li>
                <li><a class="dropdown-item" href="#" data-status="approved">Approved</a></li>
                <li><a class="dropdown-item" href="#" data-status="disapproved">Disapproved</a></li>
                <li><a class="dropdown-item" href="#" data-status="working">Working</a></li>
                <li><a class="dropdown-item" href="#" data-status="completed">Completed</a></li>
              </ul>
            </div>
          </div>
          <div class="search-row d-flex flex-column flex-md-row">
            <div class="input-group me-3 mb-2 mb-md-0">
              <span
                class="input-group-text border-primary text-primary bg-white"
              >
                <i class="material-symbols-rounded">search</i>
              </span>
              <input
                type="text"
                id="ordersSearch"
                class="form-control border-primary"
                placeholder="Search orders..."
                onkeyup="searchTable('ordersSearch', 'ordersTableBody')"
              />
            </div>
            <div class="dropdown d-md-none">
              <button
                class="btn btn-sm btn-outline-secondary dropdown-toggle"
                type="button"
                id="filterDropdownMobile"
                data-bs-toggle="dropdown"
              >
                Filter
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-status="all">All Orders</a></li>
                <li><a class="dropdown-item" href="#" data-status="pending">Pending Approval</a></li>
                <li><a class="dropdown-item" href="#" data-status="approved">Approved</a></li>
                <li><a class="dropdown-item" href="#" data-status="disapproved">Disapproved</a></li>
                <li><a class="dropdown-item" href="#" data-status="working">In Progress</a></li>
                <li><a class="dropdown-item" href="#" data-status="completed">Completed</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="ordersTable">
              <thead class="table-light">
                <tr>
                  <th>Order ID</th>
                  <th>Company</th>
                  <th>Project</th>
                  <th>Part Name</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
                <!-- Data will be populated by JavaScript -->
                <tr>
                  <td colspan="8" class="text-center">Loading orders...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="pagination-container">
            <nav aria-label="Orders pagination">
              <ul class="pagination" id="ordersPagination">
                <!-- Pagination will be added by JavaScript -->
              </ul>
            </nav>
          </div>
        </div>
      </div>

      <!-- Order Details Modal -->
      <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Order Details - <span id="modalOrderId"></span></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Customer ID</label>
                    <input type="text" class="form-control" id="modalCustomerId" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Company Name</label>
                    <input type="text" class="form-control" id="modalCompanyName" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="modalProjectName" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Part Name</label>
                    <input type="text" class="form-control" id="modalPartName" readonly>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Category</label>
                    <input type="text" class="form-control" id="modalCategory" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Target Value</label>
                    <input type="text" class="form-control" id="modalTargetValue" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Annual Volume</label>
                    <input type="text" class="form-control" id="modalAnnualVolume" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Order Date</label>
                    <input type="text" class="form-control" id="modalOrderDate" readonly>
                  </div>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">Status</label>
                <div class="d-flex align-items-center">
                  <span class="badge me-2" id="modalStatusBadge">Pending</span>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="approvalStatus" id="approveRadio" value="approved">
                    <label class="form-check-label" for="approveRadio">Approve</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="approvalStatus" id="disapproveRadio" value="disapproved">
                    <label class="form-check-label" for="disapproveRadio">Disapprove</label>
                  </div>
                </div>
              </div>
              
              <div class="mb-3" id="workingStatusSection">
                <label class="form-label">Working Status</label>
                <select class="form-select" id="workingStatusSelect">
                  <option value="Not Started">Not Started</option>
                  <option value="Working">In Progress</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>
              
              <div class="mt-3 text-center" id="fileDownloadSection">
                <a href="#" class="btn btn-success" id="downloadFileBtn" download>
                  <i class="fas fa-file-download me-2"></i>Download Project File
                </a>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="saveOrderChangesBtn">Save Changes</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Modal -->
      <div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Admin Profile</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="text-center mb-4">
                <div
                  class="avatar avatar-xl bg-gradient-primary rounded-circle mb-3"
                >
                  <i class="material-symbols-rounded text-white">person</i>
                </div>
                <h4 id="modalUserName">Loading...</h4>
                <p class="text-muted" id="modalUserEmail">Loading...</p>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Admin ID</label>
                  <input
                    type="text"
                    class="form-control"
                    id="customerId"
                    readonly
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Phone</label>
                  <input
                    type="text"
                    class="form-control"
                    id="phone_number"
                    readonly
                  />
                </div>
                <div class="col-12 mb-3">
                  <label class="form-label">Location</label>
                  <input
                    type="text"
                    class="form-control"
                    id="customerLocation"
                    readonly
                  />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button type="button" class="btn btn-primary">Save Changes</button>
            </div>
          </div>
        </div>
      </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
      // Global variables
      const rowsPerPage = 10;
      let currentPage = 1;
      let allOrders = [];
      let filteredOrders = [];
      let currentOrderId = null;

      // DOM Content Loaded
      document.addEventListener("DOMContentLoaded", async function () {
        // Check authentication
        const userEmail = sessionStorage.getItem("userEmail");
        if (!userEmail) {
          alert("You must log in first!");
          window.location.href = "sign-in.html";
          return;
        }

        // Load user profile
        await loadUserProfile(userEmail);
        
        // Initialize the page
        await fetchAllOrders();
        setupEventListeners();
        setupSidebarToggle();
      });

      // Load user profile
      async function loadUserProfile(email) {
        try {
          const response = await fetch(
            `https://backend-api-zz1t.onrender.com/api/manufacturer/user/${email}`
          );
          if (!response.ok) throw new Error("Failed to fetch user data");
          
          const user = await response.json();
          document.getElementById("userName").textContent = user.name;
          document.getElementById("modalUserName").textContent = user.name;
          document.getElementById("modalUserEmail").textContent = user.email;
          document.getElementById("customerId").value = user.customer_id || "N/A";
          document.getElementById("phone_number").value = user.phone_number || "N/A";
          document.getElementById("customerLocation").value = user.location || "N/A";
        } catch (error) {
          console.error("Error loading user profile:", error);
        }
      }

      // Fetch all orders from API
      async function fetchAllOrders() {
        try {
          const response = await fetch(
            "https://backend-api-zz1t.onrender.com/api/manufacturer/customer-requirements"
          );
          if (!response.ok) throw new Error("Failed to fetch orders");
          
          const data = await response.json();
          // Reverse to show newest first
          allOrders = [...data].reverse();
          filteredOrders = [...allOrders];
          
          updateOrderStats(allOrders);
          renderOrders(currentPage);
          setupPagination();
        } catch (error) {
          console.error("Error fetching orders:", error);
          document.getElementById("ordersTableBody").innerHTML = `
            <tr>
              <td colspan="8" class="text-center text-danger">
                Error loading orders. Please try again.
              </td>
            </tr>`;
        }
      }

      // Update order statistics
      function updateOrderStats(orders) {
        document.getElementById("totalOrdersCount").textContent = orders.length;
        
        const pendingCount = orders.filter(order => 
          !order.isApproved || order.isApproved === "Disapproved"
        ).length;
        document.getElementById("pendingOrdersCount").textContent = pendingCount;
        
        const approvedCount = orders.filter(order => 
          order.isApproved === true || order.isApproved === "Approved"
        ).length;
        document.getElementById("approvedOrdersCount").textContent = approvedCount;
        
        const completedCount = orders.filter(order => 
          order.working_status === "Completed"
        ).length;
        document.getElementById("completedOrdersCount").textContent = completedCount;
      }

      // Render orders for current page
      function renderOrders(page) {
        const tableBody = document.getElementById("ordersTableBody");
        tableBody.innerHTML = "";
        
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedOrders = filteredOrders.slice(start, end);
        
        if (paginatedOrders.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center">
                No orders found matching your criteria.
              </td>
            </tr>`;
          return;
        }
        
        paginatedOrders.forEach(order => {
          const statusBadge = getStatusBadge(order);
          const date = new Date(order.createdAt || order.date || Date.now()).toLocaleDateString();
          
          const row = `
            <tr>
              <td>${order.order_id || "N/A"}</td>
              <td>${order.cname || "N/A"}</td>
              <td>${order.pname || "N/A"}</td>
              <td>${order.Part_Name || "N/A"}</td>
              <td>${order.category || "N/A"}</td>
              <td>${statusBadge}</td>
              <td>${date}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary view-order-btn" 
                  data-order='${JSON.stringify(order)}'>
                  View/Edit
                </button>
              </td>
            </tr>`;
            
          tableBody.innerHTML += row;
        });
        
        // Add event listeners to view buttons
        document.querySelectorAll(".view-order-btn").forEach(btn => {
          btn.addEventListener("click", function() {
            const order = JSON.parse(this.getAttribute("data-order"));
            showOrderDetails(order);
          });
        });
      }

      // Get status badge HTML based on order status
      function getStatusBadge(order) {
        if (order.working_status === "Completed") {
          return `<span class="badge badge-completed">Completed</span>`;
        } else if (order.working_status === "Working") {
          return `<span class="badge badge-working">In Progress</span>`;
        } else if (order.isApproved === true || order.isApproved === "Approved") {
          return `<span class="badge badge-approved">Approved</span>`;
        } else if (order.isApproved === false || order.isApproved === "Disapproved") {
          return `<span class="badge badge-disapproved">Disapproved</span>`;
        } else {
          return `<span class="badge badge-pending">Pending</span>`;
        }
      }

      // Setup pagination
      function setupPagination() {
        const pagination = document.getElementById("ordersPagination");
        pagination.innerHTML = "";
        
        const pageCount = Math.ceil(filteredOrders.length / rowsPerPage);
        if (pageCount <= 1) return;
        
        // Previous button
        const prevLi = document.createElement("li");
        prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
        prevLi.innerHTML = `<a class="page-link" href="#">Previous</a>`;
        prevLi.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            renderOrders(currentPage);
            updatePaginationUI();
          }
        });
        pagination.appendChild(prevLi);
        
        // Page numbers
        for (let i = 1; i <= pageCount; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? "active" : ""}`;
          li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
          li.addEventListener("click", (e) => {
            e.preventDefault();
            currentPage = i;
            renderOrders(currentPage);
            updatePaginationUI();
          });
          pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement("li");
        nextLi.className = `page-item ${currentPage === pageCount ? "disabled" : ""}`;
        nextLi.innerHTML = `<a class="page-link" href="#">Next</a>`;
        nextLi.addEventListener("click", (e) => {
          e.preventDefault();
          if (currentPage < pageCount) {
            currentPage++;
            renderOrders(currentPage);
            updatePaginationUI();
          }
        });
        pagination.appendChild(nextLi);
      }

      // Update pagination UI
      function updatePaginationUI() {
        const paginationItems = document.querySelectorAll("#ordersPagination .page-item");
        paginationItems.forEach((item, index) => {
          item.classList.remove("active");
          if (index === currentPage) {
            item.classList.add("active");
          }
          
          // Update disabled states
          if (index === 0) { // Previous button
            item.classList.toggle("disabled", currentPage === 1);
          } else if (index === paginationItems.length - 1) { // Next button
            item.classList.toggle("disabled", currentPage === Math.ceil(filteredOrders.length / rowsPerPage));
          }
        });
      }

      // Show order details in modal
      // Show order details in modal with enhanced design
// Show order details in modal with enhanced design
// Show order details in modal with enhanced design
function showOrderDetails(order) {
  currentOrderId = order._id;
  
  // Determine the base URL based on the current environment
  const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  const baseUrl = isLocalhost ? 'http://localhost:' : 'https://backend-api-zz1t.onrender.com';
  
  // Create download URL - handle both local and production environments
  const downloadUrl = order.pdf_file 
    ? order.pdf_file.startsWith('http') 
      ? order.pdf_file 
      : `${baseUrl}/api/customer/download/${order.pdf_file.replace(/^\/+/, '')}`
    : null;

  // Determine if we should show approval controls
  const showApprovalControls = order.working_status !== "Completed";
  const showFinalApprovalControls = order.isApproved === "Approved" && order.working_status !== "Completed";
  
  // Create the modal content with enhanced design
  const modalBody = document.querySelector(".modal-body");
  modalBody.innerHTML = `
    <div class="order-details-container">
      <!-- Status Ribbon -->5000
      <div class="status-ribbon ${getStatusClass(order)}">
        <span>${getStatusText(order)}</span>
      </div>
      
      <!-- Main Order Info Cards -->
      <div class="row g-4 mb-4">
        <!-- Order Overview Card -->
        <div class="col-md-6">
          <div class="card info-card h-100">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Order Overview</h5>
            </div>
            <div class="card-body">
              <div class="info-item">
                <span class="info-label"><i class="fas fa-hashtag me-2"></i>Order ID:</span>
                <span class="info-value">${order.order_id || "N/A"}</span>
              </div>
              <div class="info-item">
                <span class="info-label"><i class="fas fa-calendar-day me-2"></i>Created:</span>
                <span class="info-value">${formatDate(order.createdAt)}</span>
              </div>
              <div class="info-item">
                <span class="info-label"><i class="fas fa-project-diagram me-2"></i>Project:</span>
                <span class="info-value">${order.pname || "N/A"}</span>
              </div>
              <div class="info-item">
                <span class="info-label"><i class="fas fa-tag me-2"></i>Category:</span>
                <span class="info-value">${order.category || "N/A"}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Part Details Card -->
        <div class="col-md-6">
          <div class="card info-card h-100">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-cube me-2"></i>Part Details</h5>
            </div>
            <div class="card-body">
              <div class="info-item">
                <span class="info-label"><i class="fas fa-cube me-2"></i>Part Name:</span>
                <span class="info-value">${order.Part_Name || "N/A"}</span>
              </div>
              <div class="info-item">
                <span class="info-label"><i class="fas fa-box-open me-2"></i>Blank Name:</span>
                <span class="info-value">${order.blank_name || "N/A"}</span>
              </div>
              <div class="info-item">
                <span class="info-label"><i class="fas fa-boxes me-2"></i>Quantity:</span>
                <span class="info-value">${order.tv || "N/A"}</span>
              </div>
              <div class="info-item">
                <span class="info-label"><i class="fas fa-money-bill-wave me-2"></i>Price:</span>
                <span class="info-value">${order.pr || "N/A"}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Customer & Timeline Row -->
      <div class="row g-4 mb-4">
        <!-- Customer Info Card -->
        <div class="col-md-6">
          <div class="card info-card h-100">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Customer Information</h5>
            </div>
            <div class="card-body">
              <div class="info-item">
                <span class="info-label"><i class="fas fa-building me-2"></i>Company:</span>
                <span class="info-value">${order.cname || "N/A"}</span>
              </div>
              <div class="info-item">
                <span class="info-label"><i class="fas fa-envelope me-2"></i>Email:</span>
                <span class="info-value">${order.email || "N/A"}</span>
              </div>
              <div class="info-item">
                <span class="info-label"><i class="fas fa-phone me-2"></i>Phone:</span>
                <span class="info-value">${order.phone_number || "N/A"}</span>
              </div>
              <div class="info-item">
                <span class="info-label"><i class="fas fa-map-marker-alt me-2"></i>Location:</span>
                <span class="info-value">${order.location || "N/A"}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Timeline Card -->
        <div class="col-md-6">
          <div class="card info-card h-100">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-history me-2"></i>Project Timeline</h5>
            </div>
            <div class="card-body">
              <div class="timeline-item ${order.qs ? 'active' : ''}">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                  <h6>Quote Submission</h6>
                  <p>${order.qs ? formatDate(order.qs) : 'Pending'}</p>
                </div>
              </div>
              <div class="timeline-item ${order.sop ? 'active' : ''}">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                  <h6>Start of Production</h6>
                  <p>${order.sop ? formatDate(order.sop) : 'Pending'}</p>
                </div>
              </div>
              <div class="timeline-item ${order.working_status === 'Completed' ? 'active' : ''}">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                  <h6>Completion</h6>
                  <p>${order.working_status === 'Completed' ? formatDate(new Date()) : 'Pending'}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Description & Attachments -->
      <div class="row g-4 mb-4">
        <!-- Description Card -->
        <div class="col-md-6">
          <div class="card info-card h-100">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-align-left me-2"></i>Description</h5>
            </div>
            <div class="card-body">
              <p class="description-text">${order.desc || "No description provided"}</p>
            </div>
          </div>
        </div>
        
        <!-- Attachments Card -->
        <div class="col-md-6">
          <div class="card info-card h-100">
            <div class="card-header bg-light">
              <h5 class="mb-0"><i class="fas fa-paperclip me-2"></i>Attachments</h5>
            </div>
            <div class="card-body">
              ${downloadUrl ? `
                <div class="attachment-item">
                  <div class="attachment-icon">
                    <i class="fas fa-file-pdf text-danger"></i>
                  </div>
                  <div class="attachment-info">
                    <h6>Project File</h6>
                    <button class="btn btn-sm btn-outline-primary download-btn" data-url="${downloadUrl}">
                      <i class="fas fa-download me-1"></i> Download
                    </button>
                    <div class="download-status mt-2"></div>
                  </div>
                </div>
              ` : `
                <div class="alert alert-warning">
                  No attached file available for this order
                </div>
              `}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Supplier Responses -->
      ${order.supplierResponses && order.supplierResponses.length > 0 ? `
      <div class="card info-card mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-users me-2"></i>Supplier Responses</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Supplier ID</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${order.supplierResponses.map(response => `
                  <tr>
                    <td>${response.supplier_Id || "N/A"}</td>
                    <td>
                      <span class="badge ${response.status === "Accepted" ? "badge-approved" : 
                        response.status === "Rejected" ? "badge-disapproved" : "badge-pending"}">
                        ${response.status || "N/A"}
                      </span>
                    </td>
                    <td>${formatDate(response.date)}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary view-supplier-btn me-2" 
                        data-supplier-id="${response.supplier_Id}">
                        <i class="fas fa-eye me-1"></i> View
                      </button>
                      <button class="btn btn-sm btn-outline-success contact-supplier-btn" 
                        data-supplier-id="${response.supplier_Id}">
                        <i class="fas fa-phone me-1"></i> Contact
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      ` : ''}
      
      <!-- Assigned Supplier -->
      ${order.acceptedSupplier ? `
      <div class="card info-card">
        <div class="card-header bg-light">
          <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>Assigned Supplier</h5>
        </div>
        <div class="card-body">
          <div class="assigned-supplier">
            <div class="supplier-avatar">
              <i class="fas fa-user-tie"></i>
            </div>
            <div class="supplier-info">
              <h5>Supplier ${order.acceptedSupplier.supplier_Id || "N/A"}</h5>
              <p class="text-muted mb-2">Assigned on ${formatDate(order.acceptedSupplier.acceptedAt)}</p>
              <button class="btn btn-sm btn-primary" onclick="contactSupplier('${order.acceptedSupplier.supplier_Id}')">
                <i class="fas fa-envelope me-1"></i> Contact Supplier
              </button>
            </div>
          </div>
        </div>
      </div>
      ` : ''}
    </div>
  `;

  // Set the modal title with order ID
  document.getElementById("modalOrderId").textContent = order.order_id || "N/A";

  // Add event listeners
  document.getElementById("saveOrderChangesBtn").addEventListener("click", saveOrderChanges);
  
  // Enhanced download button handler
  const downloadBtn = document.querySelector('.download-btn');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      const url = this.getAttribute('data-url');
      const statusElement = this.closest('.attachment-info').querySelector('.download-status');
      
      try {
        statusElement.innerHTML = '<span class="text-info">Preparing download...</span>';
        
        // Test if the file exists first
        const testResponse = await fetch(url, { method: 'HEAD' });
        if (!testResponse.ok) {
          throw new Error('File not found on server');
        }
        
        // Create a hidden anchor tag to trigger download
        const a = document.createElement('a');
        a.href = url;
        a.download = url.split('/').pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        statusElement.innerHTML = '<span class="text-success">Download started!</span>';
        setTimeout(() => statusElement.innerHTML = '', 3000);
      } catch (error) {
        console.error('Download failed:', error);
        statusElement.innerHTML = `<span class="text-danger">Download failed: ${error.message}</span>`;
      }
    });
  }

  // Add supplier button event listeners
  document.querySelectorAll('.view-supplier-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const supplierId = this.getAttribute('data-supplier-id');
      viewSupplierDetails(supplierId);
    });
  });

  document.querySelectorAll('.contact-supplier-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const supplierId = this.getAttribute('data-supplier-id');
      contactSupplier(supplierId);
    });
  });

  // Show the modal
  const modal = new bootstrap.Modal(document.getElementById("orderDetailsModal"));
  modal.show();
}

// Helper function to format dates
function formatDate(dateString) {
  if (!dateString) return "N/A";
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Helper function to get status class
function getStatusClass(order) {
  if (order.working_status === "Completed") return "status-completed";
  if (order.isApproved === "Approved") return "status-approved";
  if (order.isApproved === "Disapproved") return "status-disapproved";
  return "status-pending";
}

// Helper function to get status text
function getStatusText(order) {
  if (order.working_status === "Completed") return "Completed";
  if (order.isApproved === "Approved") return "Approved";
  if (order.isApproved === "Disapproved") return "Disapproved";
  return "Pending Approval";
}

document.querySelectorAll('.contact-supplier-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const supplierId = this.getAttribute('data-supplier-id');
    contactSupplier(supplierId);
  });
});

  // Function to view supplier details
  async function viewSupplierDetails(supplierId) {
  try {
    showLoading('Loading supplier details...');
    
    const response = await fetch(
      `https://backend-api-zz1t.onrender.com/api/manufacturer/supplier/simple/${supplierId}`
    );
    
    if (!response.ok) throw new Error("Failed to fetch supplier details");
    
    const supplier = await response.json();
    hideLoading();
    
    // Create modal with your exact data structure
    const supplierModalHtml = `
      <div class="modal fade" id="supplierDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">${supplier.companyName || 'Supplier'} Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="card info-card mb-3">
                    <div class="card-header bg-light">
                      <h6 class="mb-0"><i class="fas fa-building me-2"></i>Company Information</h6>
                    </div>
                    <div class="card-body">
                      <div class="info-item">
                        <span class="info-label">Supplier ID:</span>
                        <span class="info-value">${supplier.supplierId || 'N/A'}</span>
                      </div>
                      <div class="info-item">
                        <span class="info-label">Company Name:</span>
                        <span class="info-value">${supplier.companyName || 'N/A'}</span>
                      </div>
                      <div class="info-item">
                        <span class="info-label">Category:</span>
                        <span class="info-value">${supplier.category || 'N/A'}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card info-card mb-3">
                    <div class="card-header bg-light">
                      <h6 class="mb-0"><i class="fas fa-user-tie me-2"></i>Contact Information</h6>
                    </div>
                    <div class="card-body">
                      <div class="info-item">
                        <span class="info-label">Contact Person:</span>
                        <span class="info-value">${supplier.contactPerson || 'N/A'}</span>
                      </div>
                      <div class="info-item">
                        <span class="info-label">Email:</span>
                        <span class="info-value">${supplier.email || 'N/A'}</span>
                      </div>
                      <div class="info-item">
                        <span class="info-label">Phone:</span>
                        <span class="info-value">${supplier.phoneNumber || 'N/A'}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <div class="card info-card">
                    <div class="card-header bg-light">
                      <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Location</h6>
                    </div>
                    <div class="card-body">
                      <div class="info-item">
                        <span class="info-label">Address:</span>
                        <span class="info-value">${supplier.address || 'N/A'}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="contactSupplier('${supplier.supplierId}')">
                <i class="fas fa-envelope me-1"></i> Contact Supplier
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    // Add modal to DOM and show it
    document.body.insertAdjacentHTML('beforeend', supplierModalHtml);
    const supplierModal = new bootstrap.Modal(document.getElementById('supplierDetailsModal'));
    supplierModal.show();

    // Clean up modal when closed
    document.getElementById('supplierDetailsModal').addEventListener('hidden.bs.modal', function() {
      this.remove();
    });

  } catch (error) {
    hideLoading();
    console.error("Error fetching supplier details:", error);
    alert("Failed to load supplier details. Please try again.");
  }
}

// Unified contact supplier function
async function contactSupplier(supplierId) {
  try {
    showLoading('Loading supplier contact information...');
    
    const response = await fetch(
      `https://backend-api-zz1t.onrender.com/api/manufacturer/supplier/simple/${supplierId}`
    );
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || "Failed to fetch supplier details");
    }
    
    const supplier = await response.json();
    hideLoading();
    
    // Check if phone number exists first (since you prefer phone)
    if (supplier.phoneNumber) {
      // Clean the phone number (remove non-digit chars except +)
      const cleanPhone = supplier.phoneNumber.replace(/[^\d+]/g, '');
      window.location.href = `tel:${cleanPhone}`;
    } 
    // Fall back to email if no phone
    else if (supplier.email) {
      window.location.href = `mailto:${supplier.email}?subject=Regarding Project Collaboration`;
    }
    // No contact info available
    else {
      alert("This supplier hasn't provided any contact information.");
    }
  } catch (error) {
    hideLoading();
    console.error("Error contacting supplier:", error);
    alert(`Error: ${error.message}`);
  }
}

// Set up event listeners for all contact buttons
function setupContactButtons() {
  document.querySelectorAll('.contact-supplier-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const supplierId = this.getAttribute('data-supplier-id');
      contactSupplier(supplierId);
    });
  });
}

// Call this in your DOMContentLoaded or initialization function
setupContactButtons();

// Helper functions for loading states
function showLoading(message) {
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'loading-overlay';
  loadingDiv.style.position = 'fixed';
  loadingDiv.style.top = '0';
  loadingDiv.style.left = '0';
  loadingDiv.style.width = '100%';
  loadingDiv.style.height = '100%';
  loadingDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
  loadingDiv.style.display = 'flex';
  loadingDiv.style.justifyContent = 'center';
  loadingDiv.style.alignItems = 'center';
  loadingDiv.style.zIndex = '9999';
  
  loadingDiv.innerHTML = `
    <div class="text-center text-white">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">${message}</p>
    </div>
  `;
  
  document.body.appendChild(loadingDiv);
}

function hideLoading() {
  const loadingDiv = document.getElementById('loading-overlay');
  if (loadingDiv) {
    loadingDiv.remove();
  }
}




// Helper function to format dates
function formatDate(dateString) {
  if (!dateString) return "N/A";
  const date = new Date(dateString);
  return date.toLocaleDateString() + " " + date.toLocaleTimeString();
}

// Helper function to get status class
function getStatusClass(order) {
  if (order.working_status === "Completed") return "badge-completed";
  if (order.working_status === "Working") return "badge-working";
  if (order.isApproved === true || order.isApproved === "Approved") return "badge-approved";
  if (order.isApproved === false || order.isApproved === "Disapproved") return "badge-disapproved";
  return "badge-pending";
}

// Helper function to get status text
function getStatusText(order) {
  if (order.working_status === "Completed") return "Completed";
  if (order.working_status === "Working") return "In Progress";
  if (order.isApproved === true || order.isApproved === "Approved") return "Approved";
  if (order.isApproved === false || order.isApproved === "Disapproved") return "Disapproved";
  return "Pending";
}

// Save order changes
async function saveOrderChanges() {
  const approvalStatus = document.querySelector("input[name='approvalStatus']:checked")?.value;
  const workingStatus = document.getElementById("workingStatusSelect").value;
  
  if (!approvalStatus && !workingStatus) {
    alert("No changes detected.");
    return;
  }
  
  try {
    const updateData = {};
    if (approvalStatus) {
      updateData.isApproved = approvalStatus === "approved";
    }
    if (workingStatus) {
      updateData.working_status = workingStatus;
    }
    
    const response = await fetch(
      `https://backend-api-zz1t.onrender.com/api/manufacturer/update-order/${currentOrderId}`,
      {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(updateData),
      }
    );
    
    if (!response.ok) throw new Error("Failed to update order");
    
    const result = await response.json();
    alert("Order updated successfully!");
    
    // Refresh data
    await fetchAllOrders();
    
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById("orderDetailsModal"));
    modal.hide();
  } catch (error) {
    console.error("Error updating order:", error);
    alert("Failed to update order. Please try again.");
  }
}

// Contact supplier function with proper phone/email handling
async function contactSupplier(supplierId) {
  try {
    showLoading('Loading supplier contact information...');
    
    const response = await fetch(
      `https://backend-api-zz1t.onrender.com/api/manufacturer/suppliers/${supplierId}`
    );
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || "Failed to fetch supplier details");
    }
    
    const supplier = await response.json();
    hideLoading();
    
    // Check if phone number exists and is valid
    if (supplier.phoneNumber) {
      // Clean the phone number (remove all non-digit characters except +)
      const cleanPhone = supplier.phoneNumber.replace(/[^\d+]/g, '');
      
      // Open phone dialer
      window.location.href = `tel:${cleanPhone}`;
    } 
    // If no phone number but has email
    else if (supplier.email) {
      // Open email client
      window.location.href = `mailto:${supplier.email}?subject=Regarding Project Collaboration`;
    }
    // No contact information available
    else {
      alert("This supplier doesn't have any contact information registered.");
    }
  } catch (error) {
    hideLoading();
    console.error("Error contacting supplier:", error);
    alert(`Error: ${error.message}`);
  }
}

// Make sure all contact buttons are properly set up
document.querySelectorAll('.contact-supplier-btn').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const supplierId = this.getAttribute('data-supplier-id');
    contactSupplier(supplierId);
  });
});

      // Filter orders by status
      function filterOrders(status) {
        if (status === "all") {
          filteredOrders = [...allOrders];
        } else if (status === "pending") {
          filteredOrders = allOrders.filter(order => 
            !order.isApproved || order.isApproved === "Pending"
          );
        } else if (status === "approved") {
          filteredOrders = allOrders.filter(order => 
            order.isApproved === true || order.isApproved === "Approved"
          );
        } else if (status === "disapproved") {
          filteredOrders = allOrders.filter(order => 
            order.isApproved === false || order.isApproved === "Disapproved"
          );
        } else if (status === "working") {
          filteredOrders = allOrders.filter(order => 
            order.working_status === "Working"
          );
        } else if (status === "completed") {
          filteredOrders = allOrders.filter(order => 
            order.working_status === "Completed"
          );
        }
        
        currentPage = 1;
        renderOrders(currentPage);
        setupPagination();
        updateOrderStats(filteredOrders);
      }

      // Search table function
      function searchTable(inputId, tableBodyId) {
        const input = document.getElementById(inputId);
        const filter = input.value.toUpperCase();
        const tableBody = document.getElementById(tableBodyId);
        const rows = tableBody.getElementsByTagName("tr");

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const cells = row.getElementsByTagName("td");
          let found = false;

          for (let j = 0; j < cells.length - 1; j++) { // Skip last cell (actions)
            const cell = cells[j];
            if (cell) {
              const textValue = cell.textContent || cell.innerText;
              if (textValue.toUpperCase().indexOf(filter) > -1) {
                found = true;
                break;
              }
            }
          }

          row.style.display = found ? "" : "none";
        }
      }

      // Save order changes
      async function saveOrderChanges() {
        const approvalStatus = document.querySelector("input[name='approvalStatus']:checked")?.value;
        const workingStatus = document.getElementById("workingStatusSelect").value;
        
        if (!approvalStatus && !workingStatus) {
          alert("No changes detected.");
          return;
        }
        
        try {
          const updateData = {};
          if (approvalStatus) {
            updateData.isApproved = approvalStatus === "approved";
          }
          if (workingStatus) {
            updateData.working_status = workingStatus;
          }
          
          const response = await fetch(
            `https://backend-api-zz1t.onrender.com/api/manufacturer/update-order/${currentOrderId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(updateData),
            }
          );
          
          if (!response.ok) throw new Error("Failed to update order");
          
          const result = await response.json();
          alert("Order updated successfully!");
          
          // Refresh data
          await fetchAllOrders();
          
          // Close the modal
          const modal = bootstrap.Modal.getInstance(document.getElementById("orderDetailsModal"));
          modal.hide();
        } catch (error) {
          console.error("Error updating order:", error);
          alert("Failed to update order. Please try again.");
        }
      }

      // Setup event listeners
      function setupEventListeners() {
        // Logout button
        document.getElementById("logoutBtn").addEventListener("click", async function() {
          try {
            const response = await fetch(
              "https://backend-api-zz1t.onrender.com/api/manufacturer/logout",
              {
                method: "POST",
                credentials: "include",
              }
            );

            if (!response.ok) throw new Error("Logout failed");

            sessionStorage.removeItem("userEmail");
            alert("Logged out successfully!");
            window.location.href = "sign-in.html";
          } catch (error) {
            console.error("Error logging out:", error);
          }
        });
        
        // Filter dropdown items
        document.querySelectorAll(".dropdown-item[data-status]").forEach(item => {
          item.addEventListener("click", function(e) {
            e.preventDefault();
            const status = this.getAttribute("data-status");
            filterOrders(status);
          });
        });
        
        // Global search
        document.getElementById("globalSearch").addEventListener("keyup", function() {
          const searchTerm = this.value.toLowerCase();
          if (searchTerm.length >= 2 || searchTerm.length === 0) {
            filterOrdersBySearch(searchTerm);
          }
        });
        
        // Save changes button
        document.getElementById("saveOrderChangesBtn").addEventListener("click", saveOrderChanges);
      }

      // Filter orders by search term
      function filterOrdersBySearch(term) {
        if (!term) {
          filteredOrders = [...allOrders];
        } else {
          filteredOrders = allOrders.filter(order => {
            return (
              (order.order_id && order.order_id.toLowerCase().includes(term)) ||
              (order.cname && order.cname.toLowerCase().includes(term)) ||
              (order.pname && order.pname.toLowerCase().includes(term)) ||
              (order.Part_Name && order.Part_Name.toLowerCase().includes(term)) ||
              (order.category && order.category.toLowerCase().includes(term))
            );
          });
        }
        
        currentPage = 1;
        renderOrders(currentPage);
        setupPagination();
      }

      // Setup sidebar toggle functionality
      function setupSidebarToggle() {
        const hamburgerOpen = document.querySelector('.hamburger.open-sidebar');
        const hamburgerClose = document.querySelector('.hamburger.close-sidebar');
        const overlay = document.querySelector('.overlay');
        const sidebar = document.querySelector('.sidebar');

        hamburgerOpen.addEventListener('click', function() {
          sidebar.classList.add('active');
          overlay.classList.add('active');
        });

        hamburgerClose.addEventListener('click', function() {
          sidebar.classList.remove('active');
          overlay.classList.remove('active');
        });

        overlay.addEventListener('click', function() {
          sidebar.classList.remove('active');
          this.classList.remove('active');
        });
      }
    </script>
  </body>
</html>