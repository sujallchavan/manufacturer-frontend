<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manufacturer Dashboard - Order Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      .stat-card {
        transition: transform 0.3s;
        cursor: pointer;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .order-row {
        transition: background-color 0.2s;
      }
      .order-row:hover {
        background-color: #f8f9fa;
      }
      .status-badge {
        font-size: 0.8rem;
        padding: 5px 10px;
        border-radius: 20px;
      }
      .nav-pills .nav-link.active {
        background-color: #0d6efd;
      }
      #orderTable {
        font-size: 0.9rem;
      }
      .order-details {
        max-height: 70vh;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav
          id="sidebar"
          class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse"
        >
          <div class="position-sticky pt-3">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a
                  class="nav-link active text-white"
                  href="#dashboard"
                  data-bs-toggle="tab"
                >
                  <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link text-white"
                  href="#orders"
                  data-bs-toggle="tab"
                >
                  <i class="bi bi-list-check me-2"></i>All Orders
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link text-white"
                  href="#customers"
                  data-bs-toggle="tab"
                >
                  <i class="bi bi-people me-2"></i>Customers
                </a>
              </li>
              <li class="nav-item">
                <a
                  class="nav-link text-white"
                  href="#suppliers"
                  data-bs-toggle="tab"
                >
                  <i class="bi bi-truck me-2"></i>Suppliers
                </a>
              </li>
              <li class="nav-item mt-4">
                <button class="btn btn-outline-light w-100" id="logoutBtn">
                  <i class="bi bi-box-arrow-right me-2"></i>Logout
                </button>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h1 class="h2">Order Management Dashboard</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <div class="btn-group me-2">
                <button
                  class="btn btn-sm btn-outline-secondary"
                  id="refreshBtn"
                >
                  <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
              </div>
            </div>
          </div>

          <!-- Tab Content -->
          <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard">
              <div class="row mb-4">
                <div class="col-md-3 mb-3">
                  <div
                    class="card text-white bg-primary stat-card"
                    onclick="loadOrders('all')"
                  >
                    <div class="card-body">
                      <h5 class="card-title">Total Orders</h5>
                      <h2 class="card-text" id="totalOrders">0</h2>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div
                    class="card text-white bg-success stat-card"
                    onclick="loadOrders('approved')"
                  >
                    <div class="card-body">
                      <h5 class="card-title">Approved</h5>
                      <h2 class="card-text" id="approvedOrders">0</h2>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div
                    class="card text-white bg-warning stat-card"
                    onclick="loadOrders('working')"
                  >
                    <div class="card-body">
                      <h5 class="card-title">In Progress</h5>
                      <h2 class="card-text" id="workingOrders">0</h2>
                    </div>
                  </div>
                </div>
                <div class="col-md-3 mb-3">
                  <div
                    class="card text-white bg-danger stat-card"
                    onclick="loadOrders('disapproved')"
                  >
                    <div class="card-body">
                      <h5 class="card-title">Disapproved</h5>
                      <h2 class="card-text" id="disapprovedOrders">0</h2>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-8">
                  <div class="card">
                    <div class="card-header">
                      <h5>Recent Orders</h5>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead>
                            <tr>
                              <th>Order ID</th>
                              <th>Customer</th>
                              <th>Product</th>
                              <th>Status</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="recentOrdersTable">
                            <!-- Will be populated by JavaScript -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card">
                    <div class="card-header">
                      <h5>Order Status Distribution</h5>
                    </div>
                    <div class="card-body">
                      <canvas id="statusChart" height="250"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Orders Tab -->
            <div class="tab-pane fade" id="orders">
              <div class="d-flex justify-content-between mb-3">
                <h2>Order Management</h2>
                <div class="btn-group">
                  <button
                    class="btn btn-outline-primary dropdown-toggle"
                    type="button"
                    id="filterDropdown"
                    data-bs-toggle="dropdown"
                  >
                    Filter Orders
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="loadOrders('all')"
                        >All Orders</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="loadOrders('approved')"
                        >Approved</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="loadOrders('disapproved')"
                        >Disapproved</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="loadOrders('pending')"
                        >Pending Approval</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="loadOrders('working')"
                        >In Progress</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="loadOrders('completed')"
                        >Completed</a
                      >
                    </li>
                    <li>
                      <a
                        class="dropdown-item"
                        href="#"
                        onclick="loadOrders('assigned')"
                        >Assigned to Suppliers</a
                      >
                    </li>
                  </ul>
                </div>
              </div>

              <div class="card">
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover" id="orderTable">
                      <thead>
                        <tr>
                          <th>Order ID</th>
                          <th>Customer</th>
                          <th>Product</th>
                          <th>Category</th>
                          <th>Approval</th>
                          <th>Work Status</th>
                          <th>Supplier</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="orderTableBody">
                        <!-- Will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customers Tab -->
            <div class="tab-pane fade" id="customers">
              <div class="d-flex justify-content-between mb-3">
                <h2>Customer Management</h2>
              </div>
              <div class="card">
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Customer ID</th>
                          <th>Name</th>
                          <th>Email</th>
                          <th>Phone</th>
                          <th>Orders</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="customerTableBody">
                        <!-- Will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Suppliers Tab -->
            <div class="tab-pane fade" id="suppliers">
              <div class="d-flex justify-content-between mb-3">
                <h2>Supplier Management</h2>
              </div>
              <div class="card">
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Supplier ID</th>
                          <th>Name</th>
                          <th>Email</th>
                          <th>Phone</th>
                          <th>Specialization</th>
                          <th>Active Orders</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="supplierTableBody">
                        <!-- Will be populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Order Details Modal -->
    <div
      class="modal fade"
      id="orderDetailsModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Order Details - <span id="modalOrderId"></span>
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body order-details">
            <div class="row mb-3">
              <div class="col-md-6">
                <h6>Customer Information</h6>
                <p><strong>Name:</strong> <span id="customerName"></span></p>
                <p><strong>Email:</strong> <span id="customerEmail"></span></p>
                <p><strong>Phone:</strong> <span id="customerPhone"></span></p>
              </div>
              <div class="col-md-6">
                <h6>Order Information</h6>
                <p><strong>Product:</strong> <span id="productName"></span></p>
                <p><strong>Part Name:</strong> <span id="partName"></span></p>
                <p>
                  <strong>Category:</strong> <span id="productCategory"></span>
                </p>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <h6>Timeline</h6>
                <p><strong>Created:</strong> <span id="orderCreated"></span></p>
                <p>
                  <strong>Quantity Start:</strong>
                  <span id="quantityStart"></span>
                </p>
                <p><strong>SOP:</strong> <span id="sopDate"></span></p>
              </div>
              <div class="col-md-6">
                <h6>Status</h6>
                <p>
                  <strong>Approval:</strong> <span id="approvalStatus"></span>
                </p>
                <p>
                  <strong>Work Status:</strong> <span id="workStatus"></span>
                </p>
                <p>
                  <strong>Supplier:</strong> <span id="supplierInfo"></span>
                </p>
              </div>
            </div>

            <div class="mb-3">
              <h6>Description</h6>
              <p id="orderDescription"></p>
            </div>

            <div class="mb-3">
              <h6>Technical Details</h6>
              <p>
                <strong>Target Volume:</strong> <span id="targetVolume"></span>
              </p>
              <p>
                <strong>Annual Volume:</strong> <span id="annualVolume"></span>
              </p>
              <p><strong>Blank Name:</strong> <span id="blankName"></span></p>
              <p><strong>PR:</strong> <span id="prInfo"></span></p>
            </div>

            <div id="supplierResponseSection">
              <h6>Supplier Responses</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Supplier</th>
                      <th>Status</th>
                      <th>Response Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="supplierResponsesTable">
                    <!-- Will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="btn-group">
              <button
                type="button"
                class="btn btn-success"
                id="approveOrderBtn"
              >
                Approve
              </button>
              <button
                type="button"
                class="btn btn-danger"
                id="disapproveOrderBtn"
              >
                Disapprove
              </button>
              <button
                type="button"
                class="btn btn-primary"
                id="assignSupplierBtn"
              >
                Assign Supplier
              </button>
            </div>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Assign Supplier Modal -->
    <div
      class="modal fade"
      id="assignSupplierModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Assign Supplier to Order <span id="assignOrderId"></span>
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="supplierSelect" class="form-label"
                >Select Supplier</label
              >
              <select class="form-select" id="supplierSelect">
                <option value="">-- Select Supplier --</option>
                <!-- Will be populated by JavaScript -->
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="confirmAssignBtn">
              Assign
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Update Modal -->
    <div
      class="modal fade"
      id="statusUpdateModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Update Work Status</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="statusSelect" class="form-label">Select Status</label>
              <select class="form-select" id="statusSelect">
                <option value="Pending">Pending</option>
                <option value="Working">Working</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              id="confirmStatusUpdateBtn"
            >
              Update
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Global variables
      let currentOrderId = null;
      let statusChart = null;
      let suppliers = [];
      let customers = [];
      let orders = [];

      // DOM Ready
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize the dashboard
        initDashboard();

        // Event listeners
        document
          .getElementById("refreshBtn")
          .addEventListener("click", initDashboard);
        document.getElementById("logoutBtn").addEventListener("click", logout);

        // Modal buttons
        document
          .getElementById("approveOrderBtn")
          .addEventListener("click", () => updateApprovalStatus(true));
        document
          .getElementById("disapproveOrderBtn")
          .addEventListener("click", () => updateApprovalStatus(false));
        document
          .getElementById("assignSupplierBtn")
          .addEventListener("click", showAssignSupplierModal);
        document
          .getElementById("confirmAssignBtn")
          .addEventListener("click", assignSupplier);
        document
          .getElementById("confirmStatusUpdateBtn")
          .addEventListener("click", updateWorkStatus);

        // Tab change event
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach((tab) => {
          tab.addEventListener("shown.bs.tab", function (event) {
            const target = event.target.getAttribute("href");
            if (target === "#customers") {
              loadCustomers();
            } else if (target === "#suppliers") {
              loadSuppliers();
            }
          });
        });
      });

      // Initialize dashboard
      async function initDashboard() {
        try {
          // Load all initial data
          const [stats, recentOrders] = await Promise.all([
            fetch("/api/orders/statistics").then((res) => res.json()),
            fetch("/api/orders/status/Approved?limit=5").then((res) =>
              res.json()
            ),
          ]);

          // Update statistics cards
          document.getElementById("totalOrders").textContent = stats.total;
          document.getElementById("approvedOrders").textContent =
            stats.approved;
          document.getElementById("workingOrders").textContent = stats.working;
          document.getElementById("disapprovedOrders").textContent =
            stats.disapproved;

          // Update recent orders table
          updateRecentOrdersTable(recentOrders);

          // Initialize chart
          initStatusChart(stats);

          // Load initial orders if on orders tab
          if (document.querySelector(".tab-pane.active").id === "orders") {
            loadOrders("all");
          }
        } catch (error) {
          console.error("Error initializing dashboard:", error);
          alert("Failed to load dashboard data");
        }
      }

      // Initialize status chart
      function initStatusChart(stats) {
        const ctx = document.getElementById("statusChart").getContext("2d");

        if (statusChart) {
          statusChart.destroy();
        }

        statusChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [
              "Approved",
              "Disapproved",
              "Pending Approval",
              "In Progress",
              "Completed",
            ],
            datasets: [
              {
                data: [
                  stats.approved,
                  stats.disapproved,
                  stats.pendingApproval,
                  stats.working,
                  stats.completed,
                ],
                backgroundColor: [
                  "#28a745",
                  "#dc3545",
                  "#ffc107",
                  "#17a2b8",
                  "#6c757d",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      }

      // Update recent orders table
      function updateRecentOrdersTable(orders) {
        const tableBody = document.getElementById("recentOrdersTable");
        tableBody.innerHTML = "";

        orders.forEach((order) => {
          const row = document.createElement("tr");
          row.className = "order-row";
          row.innerHTML = `
                    <td>${order.order_id}</td>
                    <td>${order.cname}</td>
                    <td>${order.pname}</td>
                    <td><span class="badge ${getStatusBadgeClass(
                      order.isApproved
                    )}">${order.isApproved || "Pending"}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-order-btn" data-order-id="${
                          order._id
                        }">
                            <i class="bi bi-eye"></i> View
                        </button>
                    </td>
                `;
          tableBody.appendChild(row);
        });

        // Add event listeners to view buttons
        document.querySelectorAll(".view-order-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            showOrderDetails(orderId);
          });
        });
      }

      // Load orders with filter
      async function loadOrders(filter) {
        try {
          let url = "/api/orders/";
          switch (filter) {
            case "approved":
              url += "status/Approved";
              break;
            case "disapproved":
              url += "status/Disapproved";
              break;
            case "pending":
              url += "status/Pending";
              break;
            case "working":
              url += "working-status/Working";
              break;
            case "completed":
              url += "working-status/Completed";
              break;
            case "assigned":
              url += "orders/with-responses";
              break;
            default:
              url += "customer-requirements";
          }

          const response = await fetch(url);
          orders = await response.json();
          updateOrdersTable(orders);
        } catch (error) {
          console.error("Error loading orders:", error);
          alert("Failed to load orders");
        }
      }

      // Update orders table
      function updateOrdersTable(orders) {
        const tableBody = document.getElementById("orderTableBody");
        tableBody.innerHTML = "";

        orders.forEach((order) => {
          const row = document.createElement("tr");
          row.className = "order-row";
          row.innerHTML = `
                    <td>${order.order_id}</td>
                    <td>${order.cname}</td>
                    <td>${order.pname}</td>
                    <td>${order.category}</td>
                    <td><span class="badge ${getStatusBadgeClass(
                      order.isApproved
                    )}">${order.isApproved || "Pending"}</span></td>
                    <td><span class="badge ${getWorkStatusBadgeClass(
                      order.working_status
                    )}">${order.working_status}</span></td>
                    <td>${
                      order.acceptedSupplier?.supplier_Id || "Not assigned"
                    }</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary view-order-btn" data-order-id="${
                              order._id
                            }">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary update-status-btn" data-order-id="${
                              order._id
                            }">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </td>
                `;
          tableBody.appendChild(row);
        });

        // Add event listeners
        document.querySelectorAll(".view-order-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            showOrderDetails(orderId);
          });
        });

        document.querySelectorAll(".update-status-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const orderId = this.getAttribute("data-order-id");
            showStatusUpdateModal(orderId);
          });
        });
      }

      // Show order details modal
      async function showOrderDetails(orderId) {
        try {
          currentOrderId = orderId;
          const response = await fetch(`/api/orders/${orderId}/details`);
          const data = await response.json();

          const order = data.order;
          const customer = data.customer;
          const supplier = data.supplier;

          // Update modal content
          document.getElementById("modalOrderId").textContent = order.order_id;
          document.getElementById("customerName").textContent = order.cname;
          document.getElementById("customerEmail").textContent = order.email;
          document.getElementById("customerPhone").textContent =
            order.phone_number;
          document.getElementById("productName").textContent = order.pname;
          document.getElementById("partName").textContent = order.Part_Name;
          document.getElementById("productCategory").textContent =
            order.category;
          document.getElementById("orderCreated").textContent = new Date(
            order.createdAt
          ).toLocaleString();
          document.getElementById("quantityStart").textContent = new Date(
            order.qs
          ).toLocaleDateString();
          document.getElementById("sopDate").textContent = new Date(
            order.sop
          ).toLocaleDateString();
          document.getElementById("approvalStatus").textContent =
            order.isApproved || "Pending";
          document.getElementById("workStatus").textContent =
            order.working_status;
          document.getElementById("orderDescription").textContent = order.desc;
          document.getElementById("targetVolume").textContent = order.tv;
          document.getElementById("annualVolume").textContent = order.av;
          document.getElementById("blankName").textContent =
            order.blank_name || "N/A";
          document.getElementById("prInfo").textContent = order.pr;

          // Update supplier info
          if (supplier) {
            document.getElementById(
              "supplierInfo"
            ).textContent = `${supplier.name} (ID: ${supplier.supplier_id})`;
          } else {
            document.getElementById("supplierInfo").textContent =
              "Not assigned";
          }

          // Update approval buttons state
          const approveBtn = document.getElementById("approveOrderBtn");
          const disapproveBtn = document.getElementById("disapproveOrderBtn");

          if (order.isApproved === "Approved") {
            approveBtn.disabled = true;
            disapproveBtn.disabled = false;
          } else if (order.isApproved === "Disapproved") {
            approveBtn.disabled = false;
            disapproveBtn.disabled = true;
          } else {
            approveBtn.disabled = false;
            disapproveBtn.disabled = false;
          }

          // Update supplier responses
          updateSupplierResponsesTable(order.supplierResponses);

          // Show modal
          const modal = new bootstrap.Modal(
            document.getElementById("orderDetailsModal")
          );
          modal.show();
        } catch (error) {
          console.error("Error loading order details:", error);
          alert("Failed to load order details");
        }
      }

      // Update supplier responses table
      function updateSupplierResponsesTable(responses) {
        const tableBody = document.getElementById("supplierResponsesTable");
        tableBody.innerHTML = "";

        if (!responses || responses.length === 0) {
          document.getElementById("supplierResponseSection").style.display =
            "none";
          return;
        }

        document.getElementById("supplierResponseSection").style.display =
          "block";

        responses.forEach((response) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${response.supplier_Id}</td>
                    <td><span class="badge ${getResponseStatusBadgeClass(
                      response.status
                    )}">${response.status}</span></td>
                    <td>${
                      response.date
                        ? new Date(response.date).toLocaleString()
                        : "N/A"
                    }</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewSupplierResponse(${
                          response.supplier_Id
                        })">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                `;
          tableBody.appendChild(row);
        });
      }

      // Update approval status
      async function updateApprovalStatus(isApproved) {
        try {
          const response = await fetch(
            `/api/update-approval/${currentOrderId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ isApproved }),
            }
          );

          const result = await response.json();

          if (response.ok) {
            alert("Approval status updated successfully");
            // Refresh the order details
            showOrderDetails(currentOrderId);
            // Refresh the orders table
            loadOrders("all");
            // Refresh dashboard stats
            initDashboard();
          } else {
            throw new Error(
              result.message || "Failed to update approval status"
            );
          }
        } catch (error) {
          console.error("Error updating approval status:", error);
          alert(error.message);
        }
      }

      // Show assign supplier modal
      async function showAssignSupplierModal() {
        try {
          // Load suppliers if not already loaded
          if (suppliers.length === 0) {
            const response = await fetch("/api/suppliers");
            suppliers = await response.json();
          }

          // Update supplier select
          const supplierSelect = document.getElementById("supplierSelect");
          supplierSelect.innerHTML =
            '<option value="">-- Select Supplier --</option>';

          suppliers.forEach((supplier) => {
            const option = document.createElement("option");
            option.value = supplier.supplier_id;
            option.textContent = `${supplier.name} (${supplier.specialization})`;
            supplierSelect.appendChild(option);
          });

          // Set the order ID in the modal
          document.getElementById("assignOrderId").textContent = currentOrderId;

          // Show modal
          const modal = new bootstrap.Modal(
            document.getElementById("assignSupplierModal")
          );
          modal.show();
        } catch (error) {
          console.error("Error showing assign supplier modal:", error);
          alert("Failed to load suppliers");
        }
      }

      // Assign supplier to order
      async function assignSupplier() {
        try {
          const supplierId = document.getElementById("supplierSelect").value;

          if (!supplierId) {
            alert("Please select a supplier");
            return;
          }

          const response = await fetch(
            `/api/orders/assign-supplier/${currentOrderId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ supplierId }),
            }
          );

          const result = await response.json();

          if (response.ok) {
            alert("Supplier assigned successfully");
            // Close the modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("assignSupplierModal")
            );
            modal.hide();
            // Refresh the order details
            showOrderDetails(currentOrderId);
            // Refresh the orders table
            loadOrders("all");
          } else {
            throw new Error(result.error || "Failed to assign supplier");
          }
        } catch (error) {
          console.error("Error assigning supplier:", error);
          alert(error.message);
        }
      }

      // Show status update modal
      function showStatusUpdateModal(orderId) {
        currentOrderId = orderId;
        const modal = new bootstrap.Modal(
          document.getElementById("statusUpdateModal")
        );
        modal.show();
      }

      // Update work status
      async function updateWorkStatus() {
        try {
          const status = document.getElementById("statusSelect").value;

          const response = await fetch(
            `/api/orders/update-working-status/${currentOrderId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ working_status: status }),
            }
          );

          const result = await response.json();

          if (response.ok) {
            alert("Work status updated successfully");
            // Close the modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("statusUpdateModal")
            );
            modal.hide();
            // Refresh the orders table
            loadOrders("all");
          } else {
            throw new Error(result.error || "Failed to update work status");
          }
        } catch (error) {
          console.error("Error updating work status:", error);
          alert(error.message);
        }
      }

      // Load customers
      async function loadCustomers() {
        try {
          const response = await fetch("/api/customers");
          customers = await response.json();
          updateCustomersTable(customers);
        } catch (error) {
          console.error("Error loading customers:", error);
          alert("Failed to load customers");
        }
      }

      // Update customers table
      function updateCustomersTable(customers) {
        const tableBody = document.getElementById("customerTableBody");
        tableBody.innerHTML = "";

        customers.forEach((customer) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${customer.customer_id}</td>
                    <td>${customer.name}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.orders?.length || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger delete-customer-btn" data-customer-id="${
                          customer._id
                        }">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
          tableBody.appendChild(row);
        });

        // Add event listeners to delete buttons
        document.querySelectorAll(".delete-customer-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const customerId = this.getAttribute("data-customer-id");
            if (confirm("Are you sure you want to delete this customer?")) {
              deleteCustomer(customerId);
            }
          });
        });
      }

      // Delete customer
      async function deleteCustomer(customerId) {
        try {
          const response = await fetch(`/api/customers/${customerId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (response.ok) {
            alert("Customer deleted successfully");
            // Refresh the customers table
            loadCustomers();
          } else {
            throw new Error(result.error || "Failed to delete customer");
          }
        } catch (error) {
          console.error("Error deleting customer:", error);
          alert(error.message);
        }
      }

      // Load suppliers
      async function loadSuppliers() {
        try {
          const response = await fetch("/api/suppliers");
          suppliers = await response.json();
          updateSuppliersTable(suppliers);
        } catch (error) {
          console.error("Error loading suppliers:", error);
          alert("Failed to load suppliers");
        }
      }

      // Update suppliers table
      function updateSuppliersTable(suppliers) {
        const tableBody = document.getElementById("supplierTableBody");
        tableBody.innerHTML = "";

        suppliers.forEach((supplier) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${supplier.supplier_id}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.email}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.specialization}</td>
                    <td>${supplier.active_orders || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger delete-supplier-btn" data-supplier-id="${
                          supplier._id
                        }">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
          tableBody.appendChild(row);
        });

        // Add event listeners to delete buttons
        document.querySelectorAll(".delete-supplier-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const supplierId = this.getAttribute("data-supplier-id");
            if (confirm("Are you sure you want to delete this supplier?")) {
              deleteSupplier(supplierId);
            }
          });
        });
      }

      // Delete supplier
      async function deleteSupplier(supplierId) {
        try {
          const response = await fetch(`/api/suppliers/${supplierId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (response.ok) {
            alert("Supplier deleted successfully");
            // Refresh the suppliers table
            loadSuppliers();
          } else {
            throw new Error(result.error || "Failed to delete supplier");
          }
        } catch (error) {
          console.error("Error deleting supplier:", error);
          alert(error.message);
        }
      }

      // View supplier response
      function viewSupplierResponse(supplierId) {
        alert(`Viewing details for supplier ${supplierId}`);
        // In a real app, you would show more detailed information here
      }

      // Logout
      function logout() {
        fetch("/api/logout", {
          method: "POST",
        })
          .then((response) => {
            if (response.ok) {
              window.location.href = "/login.html";
            } else {
              throw new Error("Logout failed");
            }
          })
          .catch((error) => {
            console.error("Error logging out:", error);
            alert("Failed to logout");
          });
      }

      // Helper functions for badge classes
      function getStatusBadgeClass(status) {
        switch (status) {
          case "Approved":
            return "bg-success";
          case "Disapproved":
            return "bg-danger";
          default:
            return "bg-warning text-dark";
        }
      }

      function getWorkStatusBadgeClass(status) {
        switch (status) {
          case "Completed":
            return "bg-success";
          case "Working":
            return "bg-primary";
          default:
            return "bg-secondary";
        }
      }

      function getResponseStatusBadgeClass(status) {
        switch (status) {
          case "Accepted":
            return "bg-success";
          case "Rejected":
            return "bg-danger";
          default:
            return "bg-warning text-dark";
        }
      }
    </script>
  </body>
</html>
